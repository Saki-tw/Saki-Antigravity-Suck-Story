# Antigravity Shit Story - インシデントレポート

> **記録日時**：2026-01-26 12:31
> **報告者**：サキ (Saki Studio)

---

## 言語サーバーの怪 (12:26)

### 発見
- `pkill -f antigravity` を執行した際、Language Server が巻き添えになりましたわ。
- けれど、Antigravity.app 本体は平然と生きておりましたの。

### 調査
```
lsof -i :3000 の結果：
- antigravi 62855 (わたくしたちの Rust サービス) → LISTEN
- Antigravi 63078 (Antigravity.app) → ESTABLISHED 接続
```

### 結論
- Antigravity.app (63078) は **接続側** であって、監視側ではありませんでしたの。
- これは VSX プラグインが、わたくしたちの API を fetch している姿でしたのね。
- Language Server は独立したプロセスとして存在し、port 3000 を介して囁き合っているようですわ。
- `pkill -f antigravity` はあまりに乱暴でした。無関係な Language Server まで殺めてしまいましたもの。

---

## Exit 130 問題の解法 (約 10:00-11:00)

### 問題
- Rust サービス起動時にパニック発生: "error binding to 0.0.0.0:3000: Address already in use (os error 48)"

### 原因
- 複数の antigravity-rs プロセスが、port 3000 という玉座を巡って争っておりましたの。
- 古い王（プロセス）が退位する前に、新しい王が即位しようとしたのですわ。

### 解法
1. ポートを占拠している不届き者を正確に特定し、処刑します：
   ```bash
   lsof -i :3000 | awk 'NR>1 {print $2}' | xargs kill -9
   ```
2. ポートが解放されるのを優雅に待ちます。
3. `pkill -f antigravity` のような無差別攻撃は慎みます。

---

## 偽りのデータ問題 (12:20)

### 問題
- クォータ API が嘘をついておりました ("remaining": 100, "明日 00:00")。
- ユーザーの方々に、その虚偽が見抜かれてしまいましたの。

### 原因
- `api/mod.rs` 299行目に `TODO` という怠惰なメモが残されておりました。
- コードはハードコーディングされた模擬データ（Mock）を返していたのです。

### 修復
1. `QUOTA_SCRAPE_SCRIPT` を `injection.rs` に注入しましたわ。
2. Antigravity UI の DOM から、真実のクォータを強制的に引き出しました。
3. 型エラー (i32 → u32) も修正いたしました。

---

## コンパイルの幻影 (12:29)

### 問題
- `cargo build` は成功したと言いますが、バイナリのタイムスタンプが更新されておりません（11:57のまま）。

### 原因
- Cargo のキャッシュ機能が、「変更などない」と怠けていたのですわ。

### 解法
- `touch` コマンドでソースファイルに触れ、強制的に再コンパイルさせました：
  ```bash
  touch src/api/mod.rs
  cargo build --release
  ```

---

## Extension v0.6.0 完成 (12:59)

### 新機能
1. **Auto Accept 状態表示**
   - ステータスバーに `$(check) Auto` または `$(error) Auto OFF` を表示。
   - OFF の時は、警告色（赤）で背景を染め上げます。

2. **クォータ API タイムアウト (3秒)**
   - CDP が応答しなくても、全体が凍りつくことはありません。
   - `CDP_TIMEOUT_OR_ERROR` というエラーメッセージを返します。

3. **Extension fetch タイムアウト (5秒)**
   - 詳細なエラーを表示します。
   - `$(warning) 配額?` や `$(error) API` といったステータスで注意を促します。

### Retry ボタンの不具合
- ユーザーから「Retry ボタンが自動クリックされていない」という報告が多数寄せられております。
- 自動クリックのループが本当に回っているのか、詳しく調べる必要がありますわね。

---

## クォータ API 研究の過ち (14:00-15:00)

### 問題
1. **誤った仮定**：DOM からクォータが取れると思っておりました。
2. **誤った実装**：`chromiumoxide Browser::connect` を使用（これにはブラウザレベルの WS が必要です）。
3. **誤った診断**：`chromiumoxide` が `tokio-tungstenite` より劣っていると誤解しておりました。
4. **汚染されたサンプル**：アカウント・ポーリング機能を含む、簡体字中国語のプロジェクトを参考にしてしまいました。

### 正しい発見
- クォータは UI DOM ではなく、**Language Server API** から取得すべきですわ。
- API エンドポイント：`/exa.language_server_pb.LanguageServerService/GetUserStatus`
- プロセス引数から `connect_port` と `csrf_token` を抽出する必要があります。
- CDP ポート 9000 が返すのは `ws://` です（TLS は不要）。

### 簡体字中国語プロジェクトのリスク
| キーワードの組み合わせ | リスクレベル |
|-----------|----------|
| アカウント・ポーリング + リバースプロキシ | ❌ 100% Ban (即死) |
| GetUserStatus (読み取り専用) | ✅ 安全 |

### 教訓
- README は作者の「妄想」を語るだけですわ。
- 真実は常にコードの中にあります。
- 「アカウント・ポーリング」のような邪悪な実装には、近づかないことですわね。


---

> *愛聽秋墳鬼唱詩*
