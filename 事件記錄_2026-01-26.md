# Antigravity Shit Story - 事件記錄

> 記錄時間：2026-01-26 12:31

---

## 語言伺服器之謎 (12:26)

### 發現
- 使用 `pkill -f antigravity` 時殺掉了 Language Server
- 但 Antigravity.app 主體仍然存活

### 調查
```
lsof -i :3000 顯示：
- antigravi 62855 (我們的 Rust 服務) → LISTEN
- Antigravi 63078 (Antigravity.app) → ESTABLISHED 連接
```

### 結論
- Antigravity.app (63078) 是**連接方**，不是監聯方
- 這其實是 VSX 插件在 fetch 我們的 API
- Language Server 可能是獨立進程，透過 port 3000 通訊
- `pkill -f antigravity` 太廣泛，誤殺 Language Server

---

## Exit 130 問題解法 (約 10:00-11:00)

### 問題
- Rust 服務啟動時 panic: "error binding to 0.0.0.0:3000: Address already in use (os error 48)"

### 原因
- 多個 antigravity-rs 進程同時競爭 port 3000
- 舊進程沒有完全清理就啟動新進程

### 解法
1. 精確殺掉佔用 port 的進程：
   ```bash
   lsof -i :3000 | awk 'NR>1 {print $2}' | xargs kill -9
   ```
2. 等待 port 釋放後再啟動新服務
3. 避免使用 `pkill -f antigravity`（太廣泛）

---

## Mock 數據問題 (12:20)

### 問題
- 配額 API 回傳假數據 ("remaining": 100, "明天 00:00")
- 用戶發現被騙

### 原因
- api/mod.rs 第 299 行有 TODO 註解
- 代碼回傳硬編碼的模擬數據

### 修復（錯誤嘗試）
1. 加入 QUOTA_SCRAPE_SCRIPT 到 injection.rs
2. 嘗試從 Antigravity UI DOM 抓取配額（**此方法後來證實無效**）
3. 修復類型錯誤（i32 → u32）

---

## 編譯問題 (12:29)

### 問題
- cargo build 成功但 binary 時間戳沒更新（11:57）

### 原因
- Cargo 快取，認為沒有變更

### 解法
- `touch` 源文件強制重編：
  ```bash
  touch src/api/mod.rs
  cargo build --release
  ```

---

## Extension v0.6.0 完成 (12:59)

### 新功能
1. **Auto Accept 狀態顯示**
   - 狀態列顯示 `$(check) Auto` 或 `$(error) Auto OFF`
   - Auto OFF 時顯示紅色背景

2. **配額 API timeout (3秒)**
   - CDP 執行超時不會卡住
   - 回傳 `CDP_TIMEOUT_OR_ERROR` 錯誤訊息

3. **Extension fetch timeout (5秒)**
   - 詳細錯誤訊息顯示
   - `$(warning) 配額?` 或 `$(error) API` 狀態

### Retry 按鈕問題
- 用戶多次捕獲 Retry 按鈕未被自動點擊
- 需進一步調查自動點擊循環是否執行

---

## 配額 API 研究失誤 (14:00-15:00)

### 問題
1. **錯誤假設**：以為可以從 DOM 抓取配額
2. **錯誤實作**：使用 chromiumoxide Browser::connect（需 browser-level WS）
3. **錯誤診斷**：誤判 tokio-tungstenite 比 chromiumoxide 好
4. **錯誤抽樣**：參考了含帳號輪詢功能的簡體中文專案

### 正確發現
- 配額需從 **Language Server API** 獲取，不是 UI DOM
- API 端點：`/exa.language_server_pb.LanguageServerService/GetUserStatus`
- 需要從進程參數提取 `connect_port` 和 `csrf_token`
- CDP 端口 9000 回傳的是 `ws://`（不需要 TLS）

### 簡體中文專案風險
| 關鍵字組合 | 風險等級 |
|-----------|----------|
| 帳號輪詢 + 反代理 | ❌ 100% 被 Ban |
| GetUserStatus 只讀 | ✅ 安全 |

### 教訓
- README 只告訴你作者的發想
- 真相都在代碼裡
- 避免參考含「帳號輪詢」的實作


---

> *愛聽秋墳鬼唱詩*
